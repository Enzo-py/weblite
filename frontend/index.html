<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/chess.css">

    <script src="js/d3.v7.min.js"></script>
    <script src="js/chess_func.js"></script>
    <script src="js/toolbox.js"></script>
    <script src="js/message.js"></script>

    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&" as="style" onload="this.onload=null;this.rel='stylesheet'">
</head>
<body>
    <div id="loading-screen"><div class="spinner"></div><p></p></div>

    <main>

    </main>

    <script>
        const socket = new WebSocket("ws://127.0.0.1:5384");
        const socket_data = {last_message: null};
      
    
        function send_message(type, data, waiting_screen = false, msg = '') {
            // console.log("Sending message to server", type, waiting_screen);
            if (waiting_screen) {
                d3.select("#loading-screen").style("display", "flex");
                d3.select("#loading-screen p").text(msg);
                waiting_for_response = true;
            }
            socket.send(JSON.stringify({type: type, data: data}));
        }

        async function wait_for_message(type, timeout = 10000, only_content = false) {
            return new Promise((resolve, reject) => {
                let timeout_id = setTimeout(() => {
                    socket.removeEventListener("message", check_message)
                    reject("Timeout");
                }, timeout);

                function check_message(event) {
                    try {
                        message = JSON.parse(event.data);
                    } catch (e) {
                        console.error("Invalid JSON received:", event.data);
                        return; // Ignore invalid messages
                    }
                    if (message && message.type == type) {
                        clearTimeout(timeout_id);
                        socket.removeEventListener("message", check_message);

                        if (only_content && message.data && message.data.message) {
                            resolve(message.data.message);
                        } else if (only_content && messsage.data) {
                            resolve(message.data);
                        } else {
                            resolve(message);
                        }
                    }
                }

                socket.addEventListener("message", check_message);
            })
        }

        socket.onerror = (error) => {
            console.error("Error in WebSocket connection", error);
        };
        
        socket.onmessage = (event) => {
            content = read_message(event);
            socket_data.last_message = content;
            if (content && content.type == 'error') {
                toast("error", content.data.message);
            }

            console.log("Received message from server", content);
            waiting_for_response = false;
            d3.select("#loading-screen").style("display", "none");
            d3.select("#loading-screen p").text("");
        };
    
        socket.onopen = () => {
            console.log("Connected to WebSocket server");

            // Send a message to the server
            socket.send(JSON.stringify({type: "info", data: { message: "Hello, server!" }}));
        };
    
        socket.onclose = () => {
            message = `
                <div style="display: flex; flex-direction: column;">
                    <span style="color: var(--danger-color); font-size: 1.2rem; margin-bottom: 10px;">Server socket closed, please refresh the page to reconnect.</span>
                    <span style="font-style: italic; color: #888;">Make sure the python (backend) server is running. See README for more informations</span>
                </div>
            `
            pop_up_showcase(message);
            console.log("Disconnected from WebSocket server");
        };
    </script>
</body>
</html>